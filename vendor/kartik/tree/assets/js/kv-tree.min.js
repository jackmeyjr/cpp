/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2014 - 2015
 * @package yii2-tree-manager
 * @version 1.0.0
 *
 * Tree View Validation Module.
 *
 * Author: Kartik Visweswaran
 * Copyright: 2015, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */!function(e){"use strict";var t="kvtree",a={create:"create",createR:"create-root",trash:"remove",moveU:"move-up",moveD:"move-down",moveL:"move-left",moveR:"move-right",refresh:"refresh"},n=function(t,a){return null===t||void 0===t||0===t.length||a&&""===e.trim(t)},o=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},i=function(e,t){e.removeClass(t).addClass(t)},s=function(e){return e.split("").reduce(function(e,t){return e=(e<<5)-e+t.charCodeAt(0),e&e},0)},r=function(e){setTimeout(function(){e.fadeOut(1e3)},6e3)},l=function(){var e=0;return function(t,a){clearTimeout(e),e=setTimeout(t,a)}}(),d={timeout:3e5,data:{},remove:function(e){delete d.data[e]},exist:function(e){return!!d.data[e]&&(new Date).getTime()-d.data[e]._<d.timeout},get:function(e){return d.data[e].data},set:function(t,a,n){d.remove(t),d.data[t]={_:(new Date).getTime(),data:a},e.isFunction(n)&&n(a)}},v=function(t,a){var n=this;n.$element=e(t),n.init(a),n.listen()};v.prototype={constructor:v,init:function(t){var n=this;e.each(t,function(e,t){n[e]=t}),n.btns=e.extend({},a,n.btns),n.$tree=e("#"+n.treeId),n.$treeContainer=n.$tree.parent(),n.$detail=e("#"+n.detailId),n.$toolbar=e("#"+n.toolbarId),n.$wrapper=e("#"+n.wrapperId),n.$searchContainer=n.$wrapper.find(".kv-search-container"),n.$search=n.$wrapper.find(".kv-search-input"),n.$clear=n.$wrapper.find(".kv-search-clear"),n.select(n.$element.data("key"),!0),n.showTooltips&&n.$toolbar.find(".btn").tooltip(),d.timeout=n.cacheTimeout,n.selectNodes()},selectNodes:function(){var t=this,a=t.$element.val();if(0!==a.length&&!n(a)){var o=t.$tree.find("li");o.removeClass("kv-selected"),a=a.split(","),e(a).each(function(e,a){i(t.$tree.find('li[data-key="'+a+'"]'),"kv-selected")})}},raise:function(e){var t=this;arguments.length>1?t.$element.trigger(e,arguments[1]):t.$element.trigger(e)},enableToolbar:function(){var e=this;e.$toolbar.find("button").removeAttr("disabled")},disableToolbar:function(){var e=this;e.$toolbar.find("button").attr("disabled",!0),e.$toolbar.find(".kv-"+e.btns.createR).removeAttr("disabled")},enable:function(e){var t=this;t.$toolbar.find(".kv-"+t.btns[e]).removeAttr("disabled")},disable:function(e){var t=this;t.$toolbar.find(".kv-"+t.btns[e]).attr("disabled",!0)},showAlert:function(e,t){var a=this,n=a.$detail.find(".alert-"+t);n.removeClass("hide").hide().find("div").remove(),n.append("<div>"+e+"</div>").fadeIn(1e3),r(n)},removeAlert:function(){var e=this;e.$detail.find(".alert").addClass("hide")},renderForm:function(a,o,r){var l=this,d=l.$detail,v=o||"",c=r||!1,f=s(a+l.modelClass+l.isAdmin+v),u=l.actions.manage,h=u&&-1!==u.indexOf("?")?"&":"?";u+=encodeURI(h+t+"="+f),l.parseCache(),e.ajax({type:"post",dataType:"json",data:{id:a,modelClass:l.modelClass,isAdmin:l.isAdmin,formAction:l.formAction,parentKey:v,iconsList:l.iconsList,currUrl:l.currUrl,softDelete:l.softDelete,showFormButtons:l.showFormButtons,multiple:l.multiple,nodeView:l.nodeView,nodeAddlViews:l.nodeAddlViews},url:u,cache:!0,beforeSend:function(){d.html(""),i(d,"kv-loading")},success:function(e){"error"===e.status?(d.html(e.out),l.raise("treeview.selecterror",[a])):(d.html(e.out),l.raise("treeview.selected",[a])),d.removeClass("kv-loading"),l.$detail.find('button[type="reset"]').on("click",function(){l.removeAlert()}),l.removeAlert(),c===!1||n(c.out)||l.showAlert(c.out,c.type)}})},select:function(t,a,o){if(!n(t)){var s,r=this,l=a||!1,d=o||!1,v=r.$tree.find('li[data-key="'+t+'"]>.kv-tree-list .kv-node-detail');0!==v.length&&(r.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(v,"kv-focussed"),l?r.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(v).length>0&&t.removeClass("kv-collapsed")}):r.renderForm(t,null,d),s=v.closest("li"),s.hasClass("kv-disabled")?r.disableToolbar():r.enableToolbar(),(!s.data("removable")||s.hasClass("kv-inactive")||!s.data("removableAll")&&s.hasClass("kv-parent"))&&r.disable("remove"),s.data("movable-u")||r.disable("movable-u"),s.data("movable-d")||r.disable("movable-d"),s.data("movable-l")||r.disable("movable-l"),s.data("movable-r")||r.disable("movable-r"),r.parseParentFlag(t))}},parseParentFlag:function(t){var a,n=this,o=n.$detail.find('input[class="kv-parent-flag"]'),i=n.$tree.find('li[data-key="'+t+'"]');o.each(function(){var t=e(this);a=t.closest("div.checkbox"),a.removeClass("disabled"),i.hasClass("kv-parent")?t.removeAttr("disabled"):(t.attr("disabled","disabled"),a.addClass("disabled"))})},remove:function(){var t,a,n=this,o=n.$tree.find("li .kv-node-detail.kv-focussed"),s=o.closest("li"),r=n.messages,l=n.$detail,d=l.find("form");if((0!==o.length||s.hasClass("kv-empty"))&&window.confirm(r.removeNode)&&!s.hasClass("kv-disabled")){if(a=function(e){var a=e?r.emptyNodeRemoved:r.nodeRemoved;s.remove(),t=l.find(".alert"),t.length&&l.before(t).html("").append(t),n.showAlert(a,"info"),setTimeout(function(){l.append('<h4 class="alert text-center text-muted">'+r.selectNode+"</h4>").hide().fadeIn("slow")},5e3)},s.hasClass("kv-empty"))return void a(!0);var v=s.data("key");e.ajax({type:"post",dataType:"json",data:{id:v,"class":n.modelClass,softDelete:n.softDelete},url:n.actions.remove,beforeSend:function(){d.hide(),n.removeAlert(),i(l,"kv-loading")},success:function(e){if("success"===e.status){if((n.isAdmin||n.showInactive)&&n.softDelete){n.showAlert(e.out,"info"),d.show();var t=n.modelClass.split("\\").pop(),o=d.find('input[name="'+t+'[active]"]');o.val(!1),o.prop("checked",!1),i(s,"kv-inactive"),s.data("removableAll")&&i(s.find("li"),"kv-inactive"),i(s,"kv-inactive")}else a();n.softDelete||n.disableToolbar(),n.raise("treeview.remove",[v])}else n.showAlert(e.out,"danger"),d.show(),n.raise("treeview.removeerror",[v]);l.removeClass("kv-loading")}})}},move:function(t){var a,n,o,s=this,r=s.$tree.find("li .kv-node-detail.kv-focussed"),l=r.closest("li"),v=s.messages,c=s.$detail,f=(c.find("form"),null);if(0!==r.length&&!l.hasClass("kv-disabled")){if(l.hasClass("kv-empty"))return void window.alert(v.nodeNewMove);if("u"===t&&(f=l.prev(),0===f.length))return void window.alert(v.nodeTop);if("d"===t&&(f=l.next(),0===f.length))return void window.alert(v.nodeBottom);if("l"===t&&(f=l.parent("ul").closest("li.kv-parent"),0===f.length||f.parent("ul").hasClass("kv-tree")))return void window.alert(v.nodeLeft);if("r"===t&&(f=l.prev(),0===f.length))return void window.alert(v.nodeRight);a=l.data("key"),n=f.data("key"),e.ajax({type:"post",dataType:"json",data:{idFrom:a,idTo:n,"class":s.modelClass,dir:t},url:s.actions.move,beforeSend:function(){i(s.$treeContainer,"kv-loading-search")},success:function(r){if(c.length>0&&s.removeAlert(),"success"===r.status){switch(t){case"u":f.before(l);break;case"d":f.after(l);break;case"l":f.after(l),0===f.find("li").length&&(f.removeClass("kv-parent"),f.find("ul").remove());break;case"r":f.find("li").length>0?f.children("ul").append(l):(i(f,"kv-parent"),e(document.createElement("ul")).appendTo(f).append(l));break;default:throw"Invalid move direction '"+t+"'"}"l"===t||"r"===t?(d.timeout=0,o=c.length>0?{out:r.out,type:"success"}:!1,s.select(a,!1,o),d.timeout=s.cacheTimeout):c.length>0&&s.showAlert(r.out,"success"),s.$tree.find("li.kv-collapsed").each(function(){e(this).has(l).length>0&&e(this).removeClass("kv-collapsed")}),s.raise("treeview.move",[t,a,n])}else c.length>0&&(s.showAlert(r.out,"danger"),s.raise("treeview.moveerror",[t,a,n]));s.$treeContainer.removeClass("kv-loading-search")},error:function(e,o,i){c.length>0&&(s.removeAlert(),s.showAlert(i,"danger")),s.$treeContainer.removeClass("kv-loading-search"),s.raise("treeview.moveerror",[t,a,n])}})}},setSelected:function(){var t=this,a="",o="";t.$tree.find(".kv-selected").each(function(){var t=e(this),i=n(a)?"":",";a+=i+t.data("key"),o+=i+t.find(">.kv-tree-list .kv-node-label").text()}),t.$element.val(a),t.raise("treeview.change",[a,o]),t.raise("change")},getNewNode:function(){var e=this;return'<div class="kv-tree-list" tabindex="-1">\n   <div class="kv-node-indicators">&nbsp;</div>\n   <div class="kv-node-detail kv-focussed">\n       <span class="kv-node-label">'+e.messages.emptyNode+"</span>\n   </div>\n</div>"},create:function(){var t,a,n,o,s,r=this,l=r.$tree.find("li .kv-node-detail.kv-focussed"),d=l.closest("li"),v=r.messages;return d.hasClass("kv-disabled")?void window.alert(v.nodeDisabled):0===l.length||d.hasClass("kv-empty")?void window.alert(v.invalidCreateNode):(r.$toolbar.find(".kv-"+r.btns.trash).removeAttr("disabled"),s=d.find("> ul > li.kv-empty"),s.length>0?(a=s.data("key").replace("empty-",""),r.renderForm(null,a),l.removeClass("kv-focussed"),void i(s.find(".kv-node-detail"),"kv-focussed")):(s=e(document.createElement("li")).attr({"data-key":"empty-"+d.data("key"),"class":"kv-empty"}),n=r.getNewNode(),l.removeClass("kv-focussed"),s.append(n),d.hasClass("kv-parent")?d.children("ul").append(s):(i(d,"kv-parent"),t=e(document.createElement("ul")).append(s),d.append(t)),r.renderForm(null,d.data("key")),o=s.find(".kv-node-detail"),d.removeClass("kv-collapsed"),s.children(".kv-tree-list").focus(),o.on("click",function(){r.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(o,"kv-focussed"),a=s.data("key").replace("empty-",""),r.renderForm(null,a),r.$toolbar.find(".kv-"+r.btns.trash).removeAttr("disabled")}),void r.raise("treeview.create",[parent])))},createRoot:function(){var t=this,a=t.$tree.find(".kv-tree"),n=a.children("li.kv-empty");if(t.$tree.find(".kv-node-detail").removeClass("kv-focussed"),n.length>0)return i(n.find(".kv-node-detail"),"kv-focussed"),void t.renderForm(null,"root");var o=t.getNewNode(),s=e(document.createElement("li")).attr({"data-key":"empty-root","class":"kv-empty"});s.html(o),a.append(s),t.renderForm(null,"root");var r=s.find(".kv-node-detail");i(r,"kv-focussed"),t.$toolbar.find(".kv-"+t.btns.trash).removeAttr("disabled"),r.on("click",function(){t.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(r,"kv-focussed"),t.renderForm(null,"root"),t.$toolbar.find(".kv-"+t.btns.trash).removeAttr("disabled")}),t.raise("treeview.createroot")},toggle:function(e){var t=this,a=e.closest("li.kv-parent"),n=a.data("key");a.hasClass("kv-collapsed")?(a.removeClass("kv-collapsed"),t.raise("treeview.expand",[n])):(i(a,"kv-collapsed"),t.raise("treeview.collapse",[n]))},toggleAll:function(e,t){var a=this;return"expand"===e?(a.$tree.removeClass("kv-collapsed"),a.$tree.find(".kv-collapsed").removeClass("kv-collapsed"),void(t&&a.raise("treeview.expandall"))):(i(a.$tree.find("li.kv-parent"),"kv-collapsed"),i(a.$tree,"kv-collapsed"),void(t&&a.raise("treeview.collapseall")))},check:function(e){var t=this,a=e===!0,n=a?t.$tree:e.closest("li"),o=a?"":n.data("key");if(!(n.hasClass("kv-disabled")||a&&!t.multiple)){if(n.hasClass("kv-selected"))n.removeClass("kv-selected"),t.multiple?n.find("li:not(.kv-disabled)").removeClass("kv-selected"):(t.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),t.$element.val(""),t.raise("treeview.change",["",""]),t.raise("change")),t.raise("treeview.unchecked",[o]);else{if(t.multiple)i(n.find("li:not(.kv-disabled)"),"kv-selected");else{t.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),t.$element.val(o);var s=n.find(">.kv-tree-list .kv-node-label").text();t.raise("treeview.change",[o,s]),t.raise("change")}i(n,"kv-selected"),t.raise("treeview.checked",[o])}t.multiple&&t.setSelected()}},clear:function(){var e=this;e.$treeContainer.removeClass("kv-loading-search"),e.$tree.find(".kv-node-label").removeClass("kv-highlight")},parseCache:function(){var t=this;return t.enableCache?void e.ajaxPrefilter(function(t,a){if(t.cache){var n=a.beforeSend||e.noop,o=a.success||e.noop,i=a.url;t.cache=!1,t.beforeSend=function(){return n(),d.exist(i)?(o(d.get(i)),!1):!0},t.success=function(e){d.set(i,e,o)}}}):!1},listen:function(){var t=this;t.$tree.find(".kv-node-toggle").each(function(){e(this).on("click",function(){t.toggle(e(this))})}),t.$tree.find(".kv-node-checkbox:not(.kv-disabled)").each(function(){e(this).on("click",function(){t.check(e(this))})}),t.$treeContainer.find(".kv-root-node-toggle").on("click",function(){var a=e(this),n=a.closest(".kv-tree-container");n.hasClass("kv-collapsed")?t.toggleAll("expand",!0):t.toggleAll("collapse",!0)}),t.$treeContainer.find(".kv-root-node-checkbox").on("click",function(){{var a=e(this);a.closest(".kv-tree-container")}t.check(!0)}),t.$search.on("keyup",function(){var a=e(this).val();t.clear(),0!==a.length&&(i(t.$treeContainer,"kv-loading-search"),l(function(){t.toggleAll("collapse",!1),a=o(a),t.$tree.find(".kv-node-label").each(function(){var n=e(this),o=n.text(),s=o.search(new RegExp(a,"i"));0>s?n.removeClass("kv-highlight"):(i(n,"kv-highlight"),t.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(n).length>0&&t.removeClass("kv-collapsed")}))}),t.$treeContainer.removeClass("kv-loading-search"),t.raise("treeview.search")},1500))}),t.$clear.on("click",function(){t.$search.val(""),t.clear()}),t.$tree.find(".kv-node-detail").each(function(){e(this).on("click",function(){var a=e(this),n=a.closest("li"),o=n.data("key");return t.$tree.hasClass("kv-tree-input-widget")?(a.removeClass("kv-focussed"),void t.check(n)):void(a.hasClass("kv-focussed")||(t.select(o),t.removeAlert(),t.raise("treeview.select",[o])))})}),t.$toolbar.find(".kv-"+t.btns.create).on("click",function(){t.create()}),t.$toolbar.find(".kv-"+t.btns.createR).on("click",function(){t.createRoot()}),t.$toolbar.find(".kv-"+t.btns.trash).on("click",function(){t.remove()}),t.$toolbar.find(".kv-"+t.btns.moveU).on("click",function(){t.move("u")}),t.$toolbar.find(".kv-"+t.btns.moveD).on("click",function(){t.move("d")}),t.$toolbar.find(".kv-"+t.btns.moveL).on("click",function(){t.move("l")}),t.$toolbar.find(".kv-"+t.btns.moveR).on("click",function(){t.move("r")}),t.$detail.find(".alert").each(function(){var t=e(this);t.hasClass("hide")||(t.hide().fadeIn(1500),r(t))})}},e.fn.treeview=function(t){var a,n,o,i=Array.apply(null,arguments);return i.shift(),this.each(function(){a=e(this),n=a.data("treeview"),o="object"==typeof t&&t,n||(n=new v(this,e.extend({},e.fn.treeview.defaults,o,e(this).data())),a.data("treeview",n)),"string"==typeof t&&n[t].apply(n,i)})},e.fn.treeview.defaults={btns:{}},e.fn.treeview.Constructor=v}(window.jQuery);